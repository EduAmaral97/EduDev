

SELECT 
SE1.E1_FILIAL			AS FILIAL,
SE1.E1_PREFIXO			AS SERIE,
SE1.E1_NUM				AS DOC,
SE1.E1_TIPO				AS TIPO,
SE1.E1_EMISSAO			AS EMISSAO_NCC,
CASE
	WHEN SL1FIL.L1_EMISNF <> ''
THEN SL1FIL.L1_EMISNF
	WHEN SL1.L1_EMISNF <> ''
THEN SL1.L1_EMISNF
ELSE ''
END AS DT_FIN,
SE1.E1_CLIENTE			AS CODCLI,
SA1.A1_NOME				AS CLIENTE,
SD1.D1_SERIORI			AS SERIE_ORIGEM,
SD1.D1_NFORI			AS NOTA_ORIGEM,
CASE
	WHEN SL1FIL.L1_OPERADO <> ''
THEN SL1FIL.L1_OPERADO
	WHEN SL1.L1_OPERADO <> ''
THEN SL1.L1_OPERADO
ELSE ''
END AS FATURISTA
FROM SE1010 SE1
LEFT JOIN SA1010 SA1  ON SA1.D_E_L_E_T_ = ''  AND SA1.A1_COD = SE1.E1_CLIENTE AND SA1.A1_LOJA = SE1.E1_LOJA 
LEFT JOIN SD1010 SD1  ON SD1.D_E_L_E_T_ = ''  AND SD1.D1_FILIAL = SE1.E1_FILIAL AND SD1.D1_SERIE = SE1.E1_PREFIXO AND SD1.D1_DOC = SE1.E1_NUM AND SE1.E1_CLIENTE = SD1.D1_FORNECE AND SE1.E1_LOJA = SD1.D1_LOJA
LEFT JOIN SD2010 SD2A ON SD2A.D_E_L_E_T_ = '' AND SD2A.D2_FILIAL = SD1.D1_FILIAL AND SD2A.D2_SERIE = SD1.D1_SERIORI AND SD2A.D2_DOC = SD1.D1_NFORI AND SD2A.D2_CLIENTE = SD1.D1_FORNECE AND SD2A.D2_LOJA = SD1.D1_LOJA AND SD2A.D2_PEDIDO <> ''
LEFT JOIN SD2010 SD2B ON SD2B.D_E_L_E_T_ = '' AND SD2B.D2_FILIAL = SD1.D1_FILIAL AND SD2B.D2_SERIE = SD1.D1_SERIORI AND SD2B.D2_DOC = SD1.D1_NFORI AND SD2B.D2_CLIENTE = SD1.D1_FORNECE AND SD2B.D2_LOJA = SD1.D1_LOJA AND SD2B.D2_PEDIDO = ''
LEFT JOIN SC5010 SC5  ON SC5.D_E_L_E_T_ = ''  AND SC5.C5_FILIAL = SD2A.D2_FILIAL AND SC5.C5_NUM = SD2A.D2_PEDIDO AND SC5.C5_CLIENTE = SD2A.D2_CLIENTE AND SC5.C5_LOJACLI = SD2A.D2_LOJA   
LEFT JOIN SL1010 SL1PAI ON SL1PAI.D_E_L_E_T_ = '' AND SL1PAI.L1_FILIAL = SC5.C5_FILIAL AND SL1PAI.L1_NUM = SC5.C5_ORCRES AND SL1PAI.L1_CLIENTE = SC5.C5_CLIENTE AND SL1PAI.L1_LOJA = SC5.C5_LOJACLI
LEFT JOIN SL1010 SL1FIL ON SL1FIL.D_E_L_E_T_ = '' AND SL1FIL.L1_FILIAL = SL1PAI.L1_FILRES AND SL1FIL.L1_NUM = SL1PAI.L1_ORCRES AND SL1FIL.L1_CLIENTE = SL1PAI.L1_CLIENTE AND SL1FIL.L1_LOJA = SL1PAI.L1_LOJA
LEFT JOIN SL1010 SL1  ON SL1.D_E_L_E_T_ = '' AND SL1.L1_FILIAL = SD2B.D2_FILIAL AND SL1.L1_SERIE = SD2B.D2_SERIE AND SL1.L1_DOC = SD2B.D2_DOC AND SL1.L1_CLIENTE = SD2B.D2_CLIENTE AND SL1.L1_LOJA = SD2B.D2_LOJA
WHERE 1=1
AND SE1.D_E_L_E_T_ = '' 
AND SE1.E1_TIPO  IN ('NCC') 
AND SE1.E1_STATUS = 'A'
AND YEAR(SE1.E1_EMISSAO) IN (2018, 2019, 2020)
--AND SE1.E1_NUM = '000029117'
GROUP BY 
SE1.E1_FILIAL,
SE1.E1_PREFIXO,
SE1.E1_NUM,
SE1.E1_TIPO,
SE1.E1_EMISSAO,
SL1FIL.L1_EMISNF,
SL1.L1_EMISNF,
SE1.E1_CLIENTE,
SA1.A1_NOME,
SD1.D1_SERIORI,
SD1.D1_NFORI,
SL1FIL.L1_OPERADO,
SL1.L1_OPERADO

