



SELECT
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SD2501.D2_SERIE
	WHEN SL1A.L1_DOCPED <> ''
THEN SD2700.D2_SERIE
ELSE ''
END AS SERIE,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SD2501.D2_DOC
	WHEN SL1A.L1_DOCPED <> ''
THEN SD2700.D2_DOC 
ELSE ''
END AS DOC,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SD2501.D2_CF
	WHEN SL1A.L1_DOCPED <> ''
THEN SD2700.D2_CF
ELSE ''
END AS CFOP,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SX5501.X5_DESCRI
	WHEN SL1A.L1_DOCPED <> ''
THEN SX5700.X5_DESCRI
ELSE ''
END AS DESC_CFOP, 
SB1.B1_COD		AS CODPROD,
SL2A.L2_ITEM	AS ITEM,
SB1.B1_ZDESRDZ	AS PRODUTO,
SB1.B1_UM		AS UM,
CASE
	WHEN SUA.UA_ZTIPVND = '1'
THEN 'VAREJO'

	WHEN SUA.UA_ZTIPVND = '2'
THEN 'PROJETO'
	WHEN SUA.UA_ZTIPVND = '3'
THEN 'IND/ADEGA'
	WHEN SUA.UA_ZTIPVND = '4'
THEN 'IND/PAINEL'
	WHEN SUA.UA_ZTIPVND = '5'
THEN 'IND/CAMARA FRIA'
	WHEN SUA.UA_ZTIPVND = '6'
THEN 'IND/WALK-IN COOLER'
ELSE ''
END AS TIPO_VENDA,
SC9.C9_PEDIDO AS PEDIDO_VENDA,
SUA.UA_NUM ATENDIMENTO,
SUA.UA_ZDTLBFT AS DT_PEDIDO,
SUA.UA_ZHRLBFT AS HR_PEDIDO,
SL1A.L1_EMISNF  AS DT_FIN,
SUBSTRING(SL1A.L1_EMISNF,5,2)  AS MES_FIN,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SF2501.F2_EMISSAO
	WHEN SL1A.L1_DOCPED <> ''
THEN SF2700.F2_EMISSAO
ELSE ''
END AS DT_FAT,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SF2501.F2_HORA
	WHEN SL1A.L1_DOCPED <> ''
THEN SF2700.F2_HORA
ELSE ''
END AS HR_FAT,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SF2501.F2_FILIAL
	WHEN SL1A.L1_DOCPED <> ''
THEN SF2700.F2_FILIAL
ELSE ''
END AS FILIAL_FAT,  
SUA.UA_FILIAL 	AS FILIAL_VENDA,
SA1.A1_COD 		AS COD_CLIFOR,
SA1.A1_NOME		AS CLIFOR,
SA1.A1_BAIRRO 	AS BAIRRO,
SA1.A1_MUN  	AS CIDADE, 
SA1.A1_EST  	AS ESTADO,
SA1.A1_CEP  	AS CEP,
SA1.A1_IBGE  	AS IBGE,
SL2A.L2_QUANT	AS QTD_VEND,
SC9.C9_QTDLIB 	AS QTD_LIB,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SD2501.D2_QUANT
	WHEN SL1A.L1_DOCPED <> ''
THEN SD2700.D2_QUANT
ELSE ''
END AS QTD_FAT,	
SB1.B1_PESBRU * SL2A.L2_QUANT AS PESO_TOTAL,
(SB5.B5_ALTURA * SB5.B5_LARG * SB5.B5_COMPR) * SL2A.L2_QUANT AS CUBAGEM_TOTAL,
SL2A.L2_VRUNIT	AS VLR_UNIT,
SL2A.L2_VLRITEM AS VALOR_ITEM,
SL1A.L1_DESCONT,
CASE
	WHEN ISNULL((
SELECT
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_DATA >= SL1A.L1_EMISNF
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_DATA >= SL1A.L1_EMISNF
),0)
),0) <> 0 
THEN
ISNULL((
SELECT
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_DATA >= SL1A.L1_EMISNF
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SB1.B1_COD
AND ZZ2.ZZ2_DATA >= SL1A.L1_EMISNF
),0)
),0)
ELSE SB1.B1_CUSTD
END AS CUSTO_STD,
SB1.B1_CUSTD 	AS CUSTO_ATUAL,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SD2501.D2_CUSTO1 / SD2501.D2_QUANT
	WHEN SL1A.L1_DOCPED <> ''
THEN SD2700.D2_CUSTO1 / SD2700.D2_QUANT
ELSE ''
END AS CUSTO_MEDIO_UNIT,
CASE 
	WHEN SL1A.L1_DOC <> ''
THEN SD2501.D2_CUSTO1
	WHEN SL1A.L1_DOCPED <> ''
THEN SD2700.D2_CUSTO1
ELSE ''
END AS CUSTO_MEDIO_TOTAL,
SB1.B1_GRTRIB	AS GRUPO_TRIB,
SB1.B1_PICMENT	AS IVA ,
SB1.B1_ZPERCAT 	AS MARKUP
/*
CASE
	WHEN SUB.UB_ZCSTREP = 0
THEN 0
ELSE round((SL2A.L2_VRUNIT / (SUB.UB_ZCSTREP / SUB.UB_QUANT) - 1) * 100,2) 
END AS MARGEM_REAL
*/
FROM SUA010 SUA
--LEFT JOIN SUB010 SUB ON SUB.D_E_L_E_T_ = ''	  AND SUB.UB_FILIAL = SUA.UA_FILIAL AND SUB.UB_NUM = SUA.UA_NUM
LEFT JOIN SL1010 SL1A ON SL1A.D_E_L_E_T_ = '' 	  AND SL1A.L1_FILIAL = SUA.UA_FILIAL AND SL1A.L1_NUMATEN = SUA.UA_NUM AND SL1A.L1_ORCRES = ''
LEFT JOIN SL2010 SL2A ON SL2A.D_E_L_E_T_ = '' 	  AND SL2A.L2_FILIAL = SL1A.L1_FILIAL AND SL2A.L2_NUM = SL1A.L1_NUM 
LEFT JOIN SL2010 SL2B ON SL2B.D_E_L_E_T_ = '' 	  AND SL2B.L2_FILIAL = SL2A.L2_FILRES AND SL2B.L2_NUM = SL2A.L2_ORCRES AND SL2B.L2_PRODUTO = SL2A.L2_PRODUTO AND SL2B.L2_ITEM = SL2A.L2_ITEM
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = ''   	  AND SB1.B1_COD = SL2A.L2_PRODUTO
LEFT JOIN SC6010 SC6 ON SC6.D_E_L_E_T_ = ''   	  AND SC6.C6_FILIAL = SL2B.L2_FILIAL AND SC6.C6_NUM = SL2B.L2_PEDRES AND SC6.C6_PRODUTO = SL2B.L2_PRODUTO AND SC6.C6_ITEM = SL2B.L2_ITEM
LEFT JOIN SC9010 SC9 ON SC9.D_E_L_E_T_ = ''   	  AND SC9.C9_FILIAL = SL2B.L2_FILIAL AND SC9.C9_PEDIDO = SL2B.L2_PEDRES AND SC9.C9_PRODUTO = SL2B.L2_PRODUTO AND SC9.C9_ITEM = SL2B.L2_ITEM AND SC9.C9_BLEST = 10
LEFT JOIN SD2010 SD2700 ON SD2700.D_E_L_E_T_ = '' AND SD2700.D2_FILIAL = SC9.C9_FILIAL AND SD2700.D2_SERIE = SC9.C9_SERIENF AND SD2700.D2_DOC = SC9.C9_NFISCAL AND SD2700.D2_COD = SC9.C9_PRODUTO AND SD2700.D2_ITEM = SC9.C9_ITEM 
LEFT JOIN SD2010 SD2501 ON SD2501.D_E_L_E_T_ = '' AND SD2501.D2_FILIAL = SL2A.L2_FILIAL AND SD2501.D2_SERIE = SL2A.L2_SERIE AND SD2501.D2_DOC = SL2A.L2_DOC AND SD2501.D2_COD = SL2A.L2_PRODUTO
LEFT JOIN SF2010 SF2700 ON SF2700.D_E_L_E_T_ = '' AND SF2700.F2_FILIAL = SD2700.D2_FILIAL AND SF2700.F2_SERIE = SD2700.D2_SERIE AND SF2700.F2_DOC = SD2700.D2_DOC 
LEFT JOIN SF2010 SF2501 ON SF2501.D_E_L_E_T_ = '' AND SF2501.F2_FILIAL = SD2501.D2_FILIAL AND SF2501.F2_SERIE = SD2501.D2_SERIE AND SF2501.F2_DOC = SD2501.D2_DOC 
LEFT JOIN SX5010 SX5700 ON SX5700.D_E_L_E_T_ = '' AND SX5700.X5_CHAVE = SD2700.D2_CF 
LEFT JOIN SX5010 SX5501 ON SX5501.D_E_L_E_T_ = '' AND SX5501.X5_CHAVE = SD2501.D2_CF 
LEFT JOIN SA1010 SA1 ON SA1.D_E_L_E_T_ = ''       AND SA1.A1_COD = SUA.UA_CLIENTE AND SA1.A1_LOJA = SUA.UA_LOJA
LEFT JOIN SB5010 SB5 ON SB5.D_E_L_E_T_ = ''       AND SB5.B5_COD = SB1.B1_COD
WHERE 1=1
AND SUA.D_E_L_E_T_ = '' 
AND SL1A.L1_EMISNF <> ''
AND YEAR(SL1A.L1_EMISNF) = 2021
--AND MONTH(SL1A.L1_EMISNF) = 04
AND SUBSTRING(SB1.B1_GRUPO,1,2) IN ('MR','CF', 'MP')
AND SB1.B1_COD <> '40432'
--AND SUA.UA_VEND = '000030'
--AND SUB.UB_ZCSTREP = 0
--AND SB1.B1_COD = ''
--AND SB1.B1_COD = 'EQ1003TR'
AND SUA.UA_NUM = '034285'