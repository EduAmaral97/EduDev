
SELECT 
SD1.D1_SERIE	AS SERIE,
SD1.D1_DOC		AS NF,
SD1.D1_CF		AS CFOP,
SX5.X5_DESCRI	AS DESC_CFOP,
/*
CASE
	WHEN SD1.D1_TIPO = 'N'
THEN 'N = NORMAL'
	WHEN SD1.D1_TIPO = 'C'
THEN 'C = CANCELADO'
	WHEN SD1.D1_TIPO = 'B'
THEN 'B = BONIFICAÇÃO'
	WHEN SD1.D1_TIPO = 'D'
THEN 'D = DEVOLUÇÃO'
	WHEN SD1.D1_TIPO = 'I'
THEN 'I = INUTILIZAVÉL'
ELSE ''
END AS NATUREZA,
*/
CASE 
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'
THEN 'MERCADORIA REVENDA'
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) = 'CF'
THEN 'INDUSTRIA'
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) = 'MP'
THEN 'MATERIA PRIMA'
ELSE ''
END AS GRUPO_PROD,
SB1.B1_ZAPRES1	AS COD_APRE,
SD1.D1_COD		AS CODPROD,
SB1.B1_ZDESRDZ	AS PRODUTO,
SD1.D1_UM		AS UM,
SC7.C7_NUM		AS NUM_PC,
SC7.C7_EMISSAO	AS EMISSAO_PC,
SD1.D1_DTDIGIT	AS EMISSAO_ENTRADA,
SF1.F1_HORA		AS HORA_ENTRADA,
CASE
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR' AND SD1.D1_TIPO <> 'D'
THEN '000131'
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) IN ('CF', 'MP') AND SD1.D1_TIPO <> 'D'
THEN '000081'
ELSE ''
END AS COD_COMPRADOR,
CASE
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR' AND SD1.D1_TIPO <> 'D'
THEN 'Rodrigo.Freitas'
	WHEN SUBSTRING(SB1.B1_GRUPO,1,2) IN ('CF', 'MP') AND SD1.D1_TIPO <> 'D'
THEN 'Isabel Fernandes'
ELSE ''
END	AS COMPRADOR,
CASE
	WHEN SD1.D1_FORNECE <> ''
THEN SD1.D1_FORNECE
	WHEN SA1.A1_COD <> ''
THEN SA1.A1_COD
ELSE ''
END AS COD_CLIFOR,
CASE
	WHEN SA2.A2_NOME <> ''
THEN SA2.A2_NOME
	WHEN SA1.A1_NOME <> ''
THEN SA1.A1_NOME
ELSE ''
END AS NOME_CLIFOR,
CASE
	WHEN SA1.A1_MUN <> ''
THEN SA1.A1_MUN
	WHEN SA2.A2_MUN <> ''
THEN SA2.A2_MUN
ELSE ''
END AS CIDADE,
CASE
	WHEN SA1.A1_EST <> ''
THEN SA1.A1_EST
	WHEN SA2.A2_EST <> ''
THEN SA2.A2_EST
ELSE ''
END AS ESTADO,
SD1.D1_FILIAL	AS FILIAL,
CASE
	WHEN SD1.D1_FILIAL = '0101'
THEN 'MATRIZ'
	WHEN SD1.D1_FILIAL = '0102'
THEN 'SÃO PPAULO'
	WHEN SD1.D1_FILIAL = '0103'
THEN 'DOM. PEDRO'
ELSE ''
END AS NOME_FILIAL,
SC7.C7_QUANT	AS QTD_PC,
SD1.D1_QUANT	AS QTD_RECEBIDO,
SB1.B1_PESBRU * SD1.D1_QUANT AS PESO_TOTAL,
(SB5.B5_ALTURA * SB5.B5_LARG * SB5.B5_COMPR) * SD1.D1_QUANT AS CUBAGEM_TOTAL,
SD1.D1_TOTAL	AS VLR_PROD
FROM SD1010 SD1
LEFT JOIN SF1010 SF1 ON SF1.D_E_L_E_T_ = '' AND SF1.F1_SERIE = SD1.D1_SERIE AND SF1.F1_DOC = SD1.D1_DOC AND SF1.F1_FORNECE = SD1.D1_FORNECE
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = '' AND SB1.B1_COD = SD1.D1_COD
LEFT JOIN SC7010 SC7 ON SC7.D_E_L_E_T_ = '' AND SD1.D1_FILIAL = SC7.C7_FILENT AND SD1.D1_PEDIDO = SC7.C7_NUM AND SD1.D1_COD = SC7.C7_PRODUTO AND SD1.D1_ITEMPC = SC7.C7_ITEM
LEFT JOIN Z_USUARIOS_TOTVS ZUS ON ZUS.ID_USUARIO = SC7.C7_USER
LEFT JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = '' AND SA2.A2_COD = SD1.D1_FORNECE
LEFT JOIN SB5010 SB5 ON SB5.D_E_L_E_T_ = '' AND SB5.B5_COD = SB1.B1_COD
LEFT JOIN SX5010 SX5 ON SX5.D_E_L_E_T_ = '' AND SX5.X5_CHAVE = SD1.D1_CF AND SX5.X5_TABELA = '13'
LEFT JOIN SA1010 SA1 ON SA1.D_E_L_E_T_ = '' AND SA1.A1_COD = SD1.D1_FORNECE AND SD1.D1_CF IN ('1202','2202 ','1201', '1411', '2201', '1916','2411', '1913', '1949', '1102') AND SD1.D1_TIPO = 'D'
WHERE 1=1
AND SD1.D_E_L_E_T_ = ''
AND YEAR(SD1.D1_DTDIGIT) = '2020'
AND SUBSTRING(SB1.B1_GRUPO,1,2) IN ('MR','CF', 'MP')
--AND SD1.D1_DOC = '000005751'
