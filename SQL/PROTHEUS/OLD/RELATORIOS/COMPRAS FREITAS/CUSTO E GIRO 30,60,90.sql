

SELECT 
SB1.B1_COD			AS CODPROD,
SB1.B1_ZDESRDZ		AS PRODUTO,
SB1.B1_ZAPRES1		AS COD_APRE,
SA2.A2_COD			AS COD_FOR,
SA2.A2_NOME			AS FORNECEDOR,
SBM.BM_DESC			AS GRUPO,
ZB2.ZB2_DESFAM		AS FAMILIA,
ISNULL((
SELECT
TOP 1
Z3.ZZ3_CUSTD
FROM ZZ2010 Z2 
LEFT JOIN ZZ3010 Z3 ON Z3.D_E_L_E_T_ = '' AND Z3.ZZ3_COD = Z2.ZZ2_CODIGO 
WHERE 1=1
AND Z2.D_E_L_E_T_ = '' 
AND Z2.ZZ2_DATA = (SELECT MAX(A.ZZ2_DATA) FROM ZZ2010 A LEFT JOIN ZZ3010 B ON B.D_E_L_E_T_ = '' AND B.ZZ3_COD = A.ZZ2_CODIGO WHERE 1=1 AND A.D_E_L_E_T_ = '' AND A.ZZ2_DATA <= '20200229' AND B.ZZ3_CODPRD = Z3.ZZ3_CODPRD)
AND Z3.ZZ3_CODPRD = SB1.B1_COD
),0) AS CUSTO_JAN,
CASE 
	WHEN ISNULL((
SELECT
TOP 1
Z3.ZZ3_CUSTD
FROM ZZ2010 Z2 
LEFT JOIN ZZ3010 Z3 ON Z3.D_E_L_E_T_ = '' AND Z3.ZZ3_COD = Z2.ZZ2_CODIGO 
WHERE 1=1
AND Z2.D_E_L_E_T_ = '' 
AND Z2.ZZ2_DATA = (SELECT MAX(A.ZZ2_DATA) FROM ZZ2010 A LEFT JOIN ZZ3010 B ON B.D_E_L_E_T_ = '' AND B.ZZ3_COD = A.ZZ2_CODIGO WHERE 1=1 AND A.D_E_L_E_T_ = '' AND A.ZZ2_DATA BETWEEN '20201001' AND '20201231' AND B.ZZ3_CODPRD = Z3.ZZ3_CODPRD)
AND Z3.ZZ3_CODPRD = SB1.B1_COD
),0) > 0
THEN
ISNULL((
SELECT
TOP 1
Z3.ZZ3_CUSTD
FROM ZZ2010 Z2 
LEFT JOIN ZZ3010 Z3 ON Z3.D_E_L_E_T_ = '' AND Z3.ZZ3_COD = Z2.ZZ2_CODIGO 
WHERE 1=1
AND Z2.D_E_L_E_T_ = '' 
AND Z2.ZZ2_DATA = (SELECT MAX(A.ZZ2_DATA) FROM ZZ2010 A LEFT JOIN ZZ3010 B ON B.D_E_L_E_T_ = '' AND B.ZZ3_COD = A.ZZ2_CODIGO WHERE 1=1 AND A.D_E_L_E_T_ = '' AND A.ZZ2_DATA BETWEEN '20201001' AND '20201231' AND B.ZZ3_CODPRD = Z3.ZZ3_CODPRD)
AND Z3.ZZ3_CODPRD = SB1.B1_COD
),0)
ELSE SB1.B1_CUSTD
END AS CUSTO_DEZ,
ISNULL((SELECT SUM(B2_QATU) FROM SB2010 WHERE D_E_L_E_T_ = '' AND B2_LOCAL = '01' AND B2_COD = SB1.B1_COD),0) AS SLD_FIS,
ISNULL((SELECT SUM(B2_RESERVA) FROM SB2010 WHERE D_E_L_E_T_ = '' AND B2_LOCAL = '01' AND B2_COD = SB1.B1_COD),0) AS SLD_RES,
ISNULL((SELECT SUM(B2_QATU - B2_RESERVA) FROM SB2010 WHERE D_E_L_E_T_ = '' AND B2_LOCAL = '01' AND B2_COD = SB1.B1_COD),0) AS DLS_DISP,
ISNULL((
SELECT 
SUM(SL2A.L2_QUANT)
FROM SL1010 SL1
LEFT JOIN SL2010 SL2A ON SL2A.D_E_L_E_T_ = '' AND SL2A.L2_FILIAL = SL1.L1_FILIAL AND SL2A.L2_NUM = SL1.L1_NUM
LEFT JOIN SB1010 A ON A.D_E_L_E_T_ = '' AND A.B1_COD = SL2A.L2_PRODUTO
WHERE 1=1
AND SL1.D_E_L_E_T_ = ''
AND SL1.L1_ORCRES = ''
AND SUBSTRING(A.B1_GRUPO,1,2) = 'MR'
AND CONCAT(SL1.L1_DOCPED,SL2A.L2_DOC) <> ''
AND SL2A.L2_PRODUTO = SB1.B1_COD
AND SL1.L1_EMISNF BETWEEN DATEADD(DAY, -30, GETDATE()) AND GETDATE()
),0) AS GIRO_30DIAS,
ISNULL((
SELECT 
SUM(SL2A.L2_QUANT)
FROM SL1010 SL1
LEFT JOIN SL2010 SL2A ON SL2A.D_E_L_E_T_ = '' AND SL2A.L2_FILIAL = SL1.L1_FILIAL AND SL2A.L2_NUM = SL1.L1_NUM
LEFT JOIN SB1010 A ON A.D_E_L_E_T_ = '' AND A.B1_COD = SL2A.L2_PRODUTO
WHERE 1=1
AND SL1.D_E_L_E_T_ = ''
AND SL1.L1_ORCRES = ''
AND SUBSTRING(A.B1_GRUPO,1,2) = 'MR'
AND CONCAT(SL1.L1_DOCPED,SL2A.L2_DOC) <> ''
AND SL2A.L2_PRODUTO = SB1.B1_COD
AND SL1.L1_EMISNF BETWEEN DATEADD(DAY, -90,DATEADD(DAY, -30, GETDATE())) AND DATEADD(DAY, -30, GETDATE())
),0) AS GIRO_90DIAS
FROM SB1010 SB1
LEFT JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = '' AND SA2.A2_COD = SB1.B1_PROC AND SA2.A2_LOJA = SB1.B1_LOJPROC
LEFT JOIN SBM010 SBM ON SBM.D_E_L_E_T_ = '' AND SBM.BM_GRUPO = SB1.B1_GRUPO
LEFT JOIN ZB2010 ZB2 ON ZB2.D_E_L_E_T_ = '' AND ZB2.ZB2_CODFAM = SB1.B1_ZCODFAM 
WHERE 1=1
AND SB1.D_E_L_E_T_ = ''
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'
AND SB1.B1_MSBLQL = '2' 



