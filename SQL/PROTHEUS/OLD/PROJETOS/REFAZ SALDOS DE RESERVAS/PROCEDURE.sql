
CREATE PROCEDURE REFAZ_SALDOS_RESERVA AS

/*

Script: PROCEDURE de Saldos de Reservas separados por filial (Armazem 01 apenas)

Autor: Eduardo Jorge

Data: 30/10/2020

Descrição: Querry para refazer saldos de reservas por filiais (Remoção de reservas presas)

*/

/*     FILIAL 01 (ARMAZEM 01)      */


UPDATE SB2010 SET B2_RESERVA = ISNULL((
SELECT 
SUM(C9_QTDLIB) 
FROM SC9010 
WHERE 1=1
AND D_E_L_E_T_ = '' 
AND C9_NFISCAL = '' 
AND C9_BLEST = '' 
AND C9_FILIAL = '0101' 
AND C9_PRODUTO = SB2.B2_COD
),0) + ISNULL((
SELECT 
SUM(C0_QTDPED) + SUM(C0_QUANT)
FROM SC0010 
WHERE 1=1
AND D_E_L_E_T_ = ''
AND C0_FILRES = '0101' 
AND C0_PRODUTO = SB2.B2_COD
),0)
FROM SB2010 SB2
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_  = '' AND SB1.B1_COD = SB2.B2_COD 
WHERE 1=1
AND SB2.D_E_L_E_T_ = ''
AND SB2.B2_FILIAL = '0101'
AND SB2.B2_LOCAL = '01'
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'


/*     FILIAL 02 (ARMAZEM 01)     */


UPDATE SB2010 SET B2_RESERVA = ISNULL((
SELECT 
SUM(C9_QTDLIB) 
FROM SC9010 
WHERE 1=1
AND D_E_L_E_T_ = '' 
AND C9_NFISCAL = '' 
AND C9_BLEST = '' 
AND C9_FILIAL = '0102' 
AND C9_PRODUTO = SB2.B2_COD
),0) + ISNULL((
SELECT 
SUM(C0_QTDPED) + SUM(C0_QUANT)
FROM SC0010 
WHERE 1=1
AND D_E_L_E_T_ = ''
AND C0_FILRES = '0102' 
AND C0_PRODUTO = SB2.B2_COD
),0)
FROM SB2010 SB2
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_  = '' AND SB1.B1_COD = SB2.B2_COD 
WHERE 1=1
AND SB2.D_E_L_E_T_ = ''
AND SB2.B2_FILIAL = '0102'
AND SB2.B2_LOCAL = '01'
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'


/*     FILIAL 03 (ARMAZEM 01)     */


UPDATE SB2010 SET B2_RESERVA = ISNULL((
SELECT 
SUM(C9_QTDLIB) 
FROM SC9010 
WHERE 1=1
AND D_E_L_E_T_ = '' 
AND C9_NFISCAL = '' 
AND C9_BLEST = '' 
AND C9_FILIAL = '0103' 
AND C9_PRODUTO = SB2.B2_COD
),0) + ISNULL((
SELECT 
SUM(C0_QTDPED) + SUM(C0_QUANT)
FROM SC0010 
WHERE 1=1
AND D_E_L_E_T_ = ''
AND C0_FILRES = '0103' 
AND C0_PRODUTO = SB2.B2_COD
),0)
FROM SB2010 SB2
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_  = '' AND SB1.B1_COD = SB2.B2_COD 
WHERE 1=1
AND SB2.D_E_L_E_T_ = ''
AND SB2.B2_FILIAL = '0103'
AND SB2.B2_LOCAL = '01'
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'



GO
