
--SELECT * FROM ZANALISECOMPRAS



SELECT 
SB1.B1_COD,
SB1.B1_ZDESRDZ,
SB1.B1_ZAPRES1,
SB1.B1_GRUPO,
SA2.A2_COD,
SA2.A2_NOME,
SA2.A2_NREDUZ,
ZB2.ZB2_CODFAM,
ZB2.ZB2_DESFAM,
SL1.L1_EMISNF,
SL2.L2_QUANT,
CASE
	WHEN ISNULL((
SELECT
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_DATA >= SL1.L1_EMISNF
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_DATA >= SL1.L1_EMISNF
),0)
),0) <> 0 
THEN
ISNULL((
SELECT
TOP 1
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_DATA >= SL1.L1_EMISNF
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SL2.L2_PRODUTO
AND ZZ2.ZZ2_DATA >= SL1.L1_EMISNF
),0)
),0)
ELSE ISNULL((SELECT B1_CUSTD FROM SB1010 WHERE D_E_L_E_T_ = '' AND B1_COD = SL2.L2_PRODUTO),0)
END AS CUSTO_STD 
FROM SL1010 SL1
LEFT JOIN SL2010 SL2 ON SL2.D_E_L_E_T_ = '' AND SL2.L2_FILIAL = SL1.L1_FILIAL AND SL2.L2_NUM = SL1.L1_NUM
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = '' AND SB1.B1_COD = SL2.L2_PRODUTO
LEFT JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = '' AND SA2.A2_COD = SB1.B1_PROC AND SA2.A2_LOJA = SB1.B1_LOJPROC
LEFT JOIN ZB2010 ZB2 ON ZB2.D_E_L_E_T_ = '' AND ZB2.ZB2_CODFAM = SB1.B1_ZCODFAM
WHERE 1=1
AND SL1.D_E_L_E_T_ = ''
AND SL1.L1_ORCRES = ''
AND SL1.L1_EMISNF <> ''
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'
