

SELECT 
SB1.B1_COD,
SB1.B1_ZDESRDZ,
SB1.B1_ZAPRES1,
SB1.B1_GRUPO,
SA2.A2_COD,
SA2.A2_NOME,
SA2.A2_NREDUZ,
ZB2.ZB2_CODFAM,
ZB2.ZB2_DESFAM,
SC7.C7_EMISSAO,
SC7.C7_QUANT,
CASE
	WHEN ISNULL((
SELECT
TOP 1
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_DATA >= SC7.C7_EMISSAO
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_DATA >= SC7.C7_EMISSAO
),0)
),0) <> 0 
THEN
ISNULL((
SELECT
TOP 1
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_DATA >= SC7.C7_EMISSAO
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SC7.C7_PRODUTO
AND ZZ2.ZZ2_DATA >= SC7.C7_EMISSAO
),0)
),0)
ELSE ISNULL((SELECT B1_CUSTD FROM SB1010 WHERE D_E_L_E_T_ = '' AND B1_COD = SC7.C7_PRODUTO),0)
END AS CUSTO_STD 
FROM SC7010 SC7
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = '' AND SB1.B1_COD = SC7.C7_PRODUTO
LEFT JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = '' AND SA2.A2_COD = SB1.B1_PROC AND SA2.A2_LOJA = SB1.B1_LOJPROC
LEFT JOIN ZB2010 ZB2 ON ZB2.D_E_L_E_T_ = '' AND ZB2.ZB2_CODFAM = SB1.B1_ZCODFAM
WHERE 1=1
AND SC7.D_E_L_E_T_ = ''
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'