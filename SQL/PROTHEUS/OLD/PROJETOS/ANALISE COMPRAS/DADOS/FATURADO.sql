

SELECT 
SB1.B1_COD,
SB1.B1_ZDESRDZ,
SB1.B1_ZAPRES1,
SB1.B1_GRUPO,
SA2.A2_COD,
SA2.A2_NOME,
SA2.A2_NREDUZ,
ZB2.ZB2_CODFAM,
ZB2.ZB2_DESFAM,
SF2.F2_EMISSAO,
SD2.D2_QUANT,
CASE
	WHEN ISNULL((
SELECT
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_DATA >= SF2.F2_EMISSAO
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_DATA >= SF2.F2_EMISSAO
),0)
),0) <> 0 
THEN
ISNULL((
SELECT
TOP 1
ZZ3.ZZ3_CUSTD
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_HORA =ISNULL((
SELECT
MAX(ZZ2.ZZ2_HORA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_DATA >= SF2.F2_EMISSAO
),0)
),0)
AND ZZ2.ZZ2_DATA = ISNULL((
SELECT
MAX(ZZ2.ZZ2_DATA)
FROM ZZ2010 ZZ2
LEFT JOIN ZZ3010 ZZ3 ON ZZ3.D_E_L_E_T_ = '' AND ZZ3.ZZ3_FILIAL = ZZ2.ZZ2_FILIAL AND ZZ3.ZZ3_COD = ZZ2.ZZ2_CODIGO
WHERE 1=1
AND ZZ2.D_E_L_E_T_ = ''
AND ZZ3.ZZ3_CODPRD = SD2.D2_COD
AND ZZ2.ZZ2_DATA >= SF2.F2_EMISSAO
),0)
),0)
ELSE ISNULL((SELECT B1_CUSTD FROM SB1010 WHERE D_E_L_E_T_ = '' AND B1_COD = SD2.D2_COD),0)
END AS CUSTO_STD
FROM SF2010 SF2  
LEFT JOIN SD2010 SD2 ON SD2.D2_FILIAL = SF2.F2_FILIAL AND SD2.D2_SERIE = SF2.F2_SERIE AND SD2.D2_DOC = SF2.F2_DOC AND SD2.D2_CLIENTE = SF2.F2_CLIENTE AND SD2.D2_LOJA = SF2.F2_LOJA
LEFT JOIN SB1010 SB1 ON SB1.D_E_L_E_T_ = '' AND SB1.B1_COD = SD2.D2_COD
LEFT JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = '' AND SA2.A2_COD = SB1.B1_PROC AND SA2.A2_LOJA = SB1.B1_LOJPROC
LEFT JOIN ZB2010 ZB2 ON ZB2.D_E_L_E_T_ = '' AND ZB2.ZB2_CODFAM = SB1.B1_ZCODFAM
WHERE 1=1 
AND SF2.D_E_L_E_T_ = ''
AND SD2.D2_TIPO = 'N'
AND SF2.F2_CLIENTE NOT IN ('022105','025201','003669','006104','024752','021950','001798')
AND SUBSTRING(SB1.B1_GRUPO,1,2) = 'MR'
