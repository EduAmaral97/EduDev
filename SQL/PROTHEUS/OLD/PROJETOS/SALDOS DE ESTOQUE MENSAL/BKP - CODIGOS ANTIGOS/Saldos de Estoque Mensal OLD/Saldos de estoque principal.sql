--------------------------CREAT TABLE------------------------/


CREATE TABLE #SALDO_ESTOQUE_MENSAL
    (
     SEM_CODPROD VARCHAR(15),
   	 SEM_PRODUTO VARCHAR(70),
	 SEM_UND	 VARCHAR(2),
	 SEM_CUSTPROD FLOAT,
     Z201801 FLOAT,
     ZCUST201801 FLOAT,
     Z201802 FLOAT,
     ZCUST201802 FLOAT,
     Z201803 FLOAT,
     ZCUST201803 FLOAT,
     Z201804 FLOAT,
     ZCUST201804 FLOAT,
     Z201805 FLOAT,
     ZCUST201805 FLOAT,
     Z201806 FLOAT,
     ZCUST201806 FLOAT,
     Z201807 FLOAT,
     ZCUST201807 FLOAT,
     Z201808 FLOAT,
     ZCUST201808 FLOAT,
     Z201809 FLOAT,
     ZCUST201809 FLOAT,
     Z201810 FLOAT,
     ZCUST201810 FLOAT,
     Z201811 FLOAT,
     ZCUST201811 FLOAT,
     Z201812 FLOAT,
     ZCUST201812 FLOAT,
     Z201901 FLOAT,
     ZCUST201901 FLOAT,
     Z201902 FLOAT,
     ZCUST201902 FLOAT,
     Z201903 FLOAT,
     ZCUST201903 FLOAT,
     Z201904 FLOAT,
     ZCUST201904 FLOAT,
     Z201905 FLOAT,
     ZCUST201905 FLOAT,
     Z201906 FLOAT,
     ZCUST201906 FLOAT,
     Z201907 FLOAT,
     ZCUST201907 FLOAT,
     Z201908 FLOAT,
     ZCUST201908 FLOAT,
     Z201909 FLOAT,
     ZCUST201909 FLOAT,
     Z201910 FLOAT,
     ZCUST201910 FLOAT,
     Z201911 FLOAT,
     ZCUST201911 FLOAT,
     Z201912 FLOAT,
     ZCUST201912 FLOAT,
     Z202001 FLOAT,
     ZCUST202001 FLOAT,
     Z202002 FLOAT,
     ZCUST202002 FLOAT,
     Z202003 FLOAT,
     ZCUST202003 FLOAT,
     Z202004 FLOAT,
     ZCUST202004 FLOAT
    )
    
   

/-----------------INSERT NA TABELA TEMPORARIA----------------------/


DEFINE @cDatIni VARCHAR(8)
DEFINE @cDatFim VARCHAR(8)
DECLARE @cDatIni VARCHAR(8)
DECLARE @cDatFim VARCHAR(8)
SET @cDatIni = '20180101'
SET @cDatFim = '20180131'


INSERT INTO #SALDO_ESTOQUE_MENSAL (SEM_CODPROD, SEM_PRODUTO, SEM_UND, SEM_CUSTPROD, Z201801, ZCUST201801) 

SELECT *,
(SELECT_PRINCIPAL.SALDO_FINAL * SELECT_PRINCIPAL.CUSTO_PROD) AS CUSTO_FINAL
FROM(
SELECT 
SALDO.COD_PROD,
SALDO.PRODUTO,
SALDO.UND,
SALDO.CUSTO_PROD,
--SALDO.SLD_INI_SB9,
--SALDO.QTD_ENT_SD1,
--SALDO.QTD_SAI_SD2,
--SALDO.QTD_ENT_SD3,
--SALDO.QTD_SAI_SD3,
SALDO.SLD_INI_SB9 + ( SALDO.QTD_ENT_SD1 + SALDO.QTD_ENT_SD3 ) - ( SALDO.QTD_SAI_SD2 + SALDO.QTD_SAI_SD3 ) AS SALDO_FINAL
FROM (
SELECT 	A.B1_COD  AS COD_PROD,
		A.B1_DESC AS PRODUTO,
		A.B1_UM   AS UND,
		A.B1_CUSTD AS CUSTO_PROD,
		ISNULL(( SELECT SUM(B9_QINI)  FROM SB9010 WHERE D_E_L_E_T_ = '' AND B9_COD = A.B1_COD AND YEAR(B9_DATA) = 2017),0) AS SLD_INI_SB9,
		ISNULL(( SELECT SUM(D1_QUANT) FROM SD1010 AS SD1, SF4010 AS SF4 WHERE SD1.D_E_L_E_T_ = '' AND SF4.D_E_L_E_T_ = '' AND SD1.D1_COD = A.B1_COD AND SD1.D1_DTDIGIT BETWEEN @cDatIni AND @cDatFim AND SD1.D1_TES = SF4.F4_CODIGO AND SF4.F4_ESTOQUE = 'S'),0) AS QTD_ENT_SD1,
		ISNULL(( SELECT SUM(D2_QUANT) FROM SD2010 AS SD2, SF4010 AS SF4 WHERE SD2.D_E_L_E_T_ = '' AND SF4.D_E_L_E_T_ = '' AND SD2.D2_COD = A.B1_COD AND SD2.D2_EMISSAO BETWEEN @cDatIni AND @cDatFim AND SD2.D2_TES = SF4.F4_CODIGO AND SF4.F4_ESTOQUE = 'S'),0) AS QTD_SAI_SD2,
		ISNULL(( SELECT SUM(D3_QUANT) FROM SD3010  WHERE D_E_L_E_T_ = '' AND D3_COD = A.B1_COD AND D3_TM <= '499' AND D3_EMISSAO BETWEEN @cDatIni AND @cDatFim),0) AS QTD_ENT_SD3,
		ISNULL(( SELECT SUM(D3_QUANT) FROM SD3010  WHERE D_E_L_E_T_ = '' AND D3_COD = A.B1_COD AND D3_TM >= '500' AND D3_EMISSAO BETWEEN @cDatIni AND @cDatFim),0) AS QTD_SAI_SD3	
FROM SB1010 A
LEFT JOIN SD1010 B ON A.B1_COD = B.D1_COD AND B.D_E_L_E_T_ = ''
LEFT JOIN SD2010 C ON A.B1_COD = C.D2_COD AND C.D_E_L_E_T_ = ''
LEFT JOIN SD3010 D ON A.B1_COD = D.D3_COD AND D.D_E_L_E_T_ = ''
LEFT JOIN SB9010 E ON A.B1_COD = E.B9_COD AND E.D_E_L_E_T_ = ''
WHERE 1=1
AND A.D_E_L_E_T_ = ''
--AND A.B1_GRUPO = 'MPCH'
--AND A.B1_COD = 'LB012F'
GROUP BY A.B1_COD, A.B1_DESC, A.B1_UM, A.B1_CUSTD
) AS SALDO
) AS SELECT_PRINCIPAL



/---------------SELECT TABELA TEMPORARIA--------------------/


SELECT 
 	 *
FROM #SALDO_ESTOQUE_MENSAL


/---------------DROP TABELA---------------------------/


DROP TABLE #SALDO_ESTOQUE_MENSAL 


/--------------------FIM------------------------------/
