/*

Relatorio de Comissões separado por grupo de produto (UT e EQ)

Calculo Fator: "BASE (SE3)" / "VLR ITEM (SL2)"

Calculo Final: "VLR ITEM (SL2) UT ou EQ" * "FATOR"

Obs: Filtrar o Vendedor (Cod.) e o periodo de emissao da Comissão (Ano e Mês)

Exemplo:

Fator = MAPA.BASE / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = FILIAL AND L2_NUM = ORC AND L2_ORCRES = ''),NULL) 
Calculo = ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = FILIAL AND A.L2_NUM = ORC AND B.B1_GRUPO = 'MRUT'),0) * (MAPA.BASE / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = FILIAL AND L2_NUM = ORC),NULL))


*/

SELECT
SE3.E3_FILIAL,
SE3.E3_SERIE,
SE3.E3_NUM,
CASE
	WHEN SL1501.L1_DOC <> '' 
THEN SUA501.UA_NUM
	WHEN SL1700.L1_DOCPED <> '' 
THEN SUA700.UA_NUM
ELSE ''
END AS ATENDIMENTO,
SE3.E3_EMISSAO	AS EMISSAO,
CASE
	WHEN SL1501.L1_DOC <> '' 
THEN SA1501.A1_COD
	WHEN SL1700.L1_DOCPED <> '' 
THEN SA1700.A1_COD
ELSE ''
END AS COD_CLI,
CASE
	WHEN SL1501.L1_DOC <> '' 
THEN SA1501.A1_NOME
	WHEN SL1700.L1_DOCPED <> '' 
THEN SA1700.A1_NOME
ELSE ''
END AS CLIENTE,
SE3.E3_VEND,
SA3.A3_NOME,
CASE
	WHEN SL1501.L1_DOC <> '' AND SE3.E3_ZCODRT = ''
THEN SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0)
	WHEN SL1700.L1_DOCPED <> '' AND SE3.E3_ZCODRT = ''
THEN SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0)
ELSE 0
END AS FATOR,
CASE
	WHEN SL1501.L1_DOC <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1501.L1_FILIAL AND A.L2_NUM = SL1501.L1_NUM AND B.B1_GRUPO = 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0))
	WHEN SL1700.L1_DOCPED <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1700.L1_FILIAL AND A.L2_NUM = SL1700.L1_NUM AND B.B1_GRUPO = 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0))
ELSE 0
END AS TOTAL_UT,
CASE
	WHEN SL1501.L1_DOC <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1501.L1_FILIAL AND A.L2_NUM = SL1501.L1_NUM AND B.B1_GRUPO <> 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0))
	WHEN SL1700.L1_DOCPED <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1700.L1_FILIAL AND A.L2_NUM = SL1700.L1_NUM AND B.B1_GRUPO <> 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0))
ELSE 0
END AS TOTAL_EQ,
CASE
	WHEN SL1501.L1_DOC <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0))
	WHEN SL1700.L1_DOCPED <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0))
ELSE 0
END AS TOTAL_PROD,
CASE
	WHEN SL1501.L1_DOC <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1501.L1_FILIAL AND A.L2_NUM = SL1501.L1_NUM AND B.B1_GRUPO = 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0)) * 0.03
	WHEN SL1700.L1_DOCPED <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1700.L1_FILIAL AND A.L2_NUM = SL1700.L1_NUM AND B.B1_GRUPO = 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0)) * 0.03
ELSE 0
END AS COMISSAO_UT,
CASE
	WHEN SL1501.L1_DOC <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1501.L1_FILIAL AND A.L2_NUM = SL1501.L1_NUM AND B.B1_GRUPO <> 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1501.L1_FILIAL AND L2_NUM = SL1501.L1_NUM),0)) * 0.015
	WHEN SL1700.L1_DOCPED <> '' AND SE3.E3_ZCODRT = ''
THEN ISNULL((SELECT SUM(A.L2_VLRITEM) FROM SL2010 A LEFT JOIN SB1010 B ON B.D_E_L_E_T_ = '' AND B.B1_COD = A.L2_PRODUTO WHERE A.D_E_L_E_T_ = '' AND A.L2_FILIAL = SL1700.L1_FILIAL AND A.L2_NUM = SL1700.L1_NUM AND B.B1_GRUPO <> 'MRUT'),0) * (SUM(SE3.E3_BASE) / ISNULL((SELECT SUM(L2_VLRITEM) FROM SL2010 WHERE D_E_L_E_T_ = '' AND L2_FILIAL = SL1700.L1_FILIAL AND L2_NUM = SL1700.L1_NUM),0)) * 0.015
ELSE 0
END AS COMISSAO_EQ,
CASE
	WHEN SE3.E3_ZCODRT <> ''
THEN SUM(SE3.E3_BASE)
ELSE 0
END AS DESCONTOS,
CASE
	WHEN SE3.E3_ZCODRT = ''
THEN SUM(SE3.E3_BASE)
ELSE 0
END AS BASE
FROM SE3010 SE3
LEFT JOIN SA3010 SA3 ON SA3.D_E_L_E_T_ = '' AND SA3.A3_COD = SE3.E3_VEND
LEFT JOIN SL1010 SL1501 ON SL1501.D_E_L_E_T_ = '' AND SL1501.L1_FILIAL = SE3.E3_FILIAL AND SL1501.L1_SERIE = SE3.E3_SERIE AND SL1501.L1_DOC = SE3.E3_NUM AND SL1501.L1_VEND = SE3.E3_VEND AND SL1501.L1_ORCRES = ''
LEFT JOIN SL1010 SL1700 ON SL1700.D_E_L_E_T_ = '' AND SL1700.L1_FILIAL = SE3.E3_FILIAL AND SL1700.L1_SERPED = SE3.E3_SERIE AND SL1700.L1_DOCPED = SE3.E3_NUM AND SL1700.L1_VEND = SE3.E3_VEND AND SL1700.L1_ORCRES = ''
LEFT JOIN SUA010 SUA501 ON SUA501.D_E_L_E_T_ = '' AND SUA501.UA_FILIAL = SL1501.L1_FILIAL AND SUA501.UA_NUM = SL1501.L1_NUMATEN
LEFT JOIN SUA010 SUA700 ON SUA700.D_E_L_E_T_ = '' AND SUA700.UA_FILIAL = SL1700.L1_FILIAL AND SUA700.UA_NUM = SL1700.L1_NUMATEN
LEFT JOIN SA1010 SA1501 ON SA1501.D_E_L_E_T_ = '' AND SA1501.A1_COD = SUA501.UA_CLIENTE AND SA1501.A1_LOJA = SUA501.UA_LOJA
LEFT JOIN SA1010 SA1700 ON SA1700.D_E_L_E_T_ = '' AND SA1700.A1_COD = SUA700.UA_CLIENTE AND SA1700.A1_LOJA = SUA700.UA_LOJA
WHERE 1=1
AND SE3.D_E_L_E_T_ = ''
AND YEAR(SE3.E3_EMISSAO) = YEAR(GETDATE())
AND MONTH(SE3.E3_EMISSAO) = 05
--AND SE3.E3_VEND = '000030'
--AND SE3.E3_NUM = '000000632'
--AND SE3.E3_NUM = '000030142'
GROUP BY 
SE3.E3_FILIAL,
SE3.E3_SERIE,
SE3.E3_NUM,
SUA501.UA_NUM,
SUA700.UA_NUM,
SE3.E3_EMISSAO,
SA1501.A1_COD,
SA1700.A1_COD,
SA1501.A1_NOME,
SA1700.A1_NOME,
SE3.E3_VEND,
SA3.A3_NOME,
SL1501.L1_DOC,
SL1700.L1_DOCPED,
SL1501.L1_FILIAL,
SL1700.L1_FILIAL,
SL1501.L1_NUM,
SL1700.L1_NUM,
SE3.E3_ZCODRT










