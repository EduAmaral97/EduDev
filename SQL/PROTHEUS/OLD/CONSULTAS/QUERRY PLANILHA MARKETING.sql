--Geração das Situações dos Produtos para Marketing ( TOBIAS )


SELECT 
A.B1_COD,
A.B1_ZIDWEB, 
A.B1_GRUPO, 
A.B1_DESC,
A.B1_ZDESRDZ,
A.B1_PESBRU	AS PESO_BRUTO,
B5_ALTURA	AS ALTURA, 
B5_COMPR	AS COMPRIMENTO,	 
B5_LARG		AS LARGHURA,
A.B1_ZAPRES1,
D.ZB2_DESFAM,
A.B1_PROC,
A.B1_LOJPROC,
E.A2_NOME,
A.B1_GRTRIB,
A.B1_ZPROMOC  AS PROMOCAO,
A.B1_ZMKTPLC  AS MARKETPLACE,
CASE
	WHEN A.B1_SITPROD = 'OL'
THEN 'S'
ELSE 'N'
END AS ENCALHADO,
A.B1_ZPERDES,
A.B1_ZPROWEB,
A.B1_ZPDEWEB,
A.B1_ZUPSITE,
A.B1_ZMIXFL1 AS MIX,
-- Data da Ultima Entrada do Produto ( COMPRA )
ISNULL((SELECT CONVERT(VARCHAR,CAST(MAX(SD1.D1_EMISSAO) AS DATETIME), 103 ) 
FROM SD1010 AS SD1, SF4010 AS SF4
WHERE SD1.D_E_L_E_T_ = '' AND SF4.D_E_L_E_T_ = ''
AND SD1.D1_TES  = SF4.F4_CODIGO
AND SD1.D1_COD  = A.B1_COD
AND SF4.F4_UPRC = 'S' ),'  /  /    ') AS ULTENT,
-- Data da Ultima Saída do Produto ( VENDA )´



ISNULL(( SELECT CONVERT(VARCHAR,CAST(MAX(SD2.D2_EMISSAO) AS DATETIME), 103 )
FROM SD2010 AS SD2, SF4010 AS SF4
WHERE SD2.D_E_L_E_T_ = '' AND SF4.D_E_L_E_T_ = ''
AND SD2.D2_TES = SF4.F4_CODIGO
AND SD2.D2_COD = A.B1_COD
AND SF4.F4_ZCALCDM = 'S' ),'  /  /    ') AS ULTSAI,
CASE
	WHEN YEAR(A.B1_UCOM) = 1900
THEN ' / / '
ELSE (CONVERT(VARCHAR,CAST(A.B1_UCOM AS DATETIME), 103 )) 
END AS ULTCOMP,
A.B1_CUSTD,
A.B1_ZPERCAT,
-- Tabela IND
ISNULL(( SELECT TOP 1 DA1.DA1_PRCVEN
       FROM DA1010 AS DA1, SB1010 AS SB1
       WHERE DA1.D_E_L_E_T_ = '' AND SB1.D_E_L_E_T_ = ''
         AND DA1.DA1_CODPRO = SB1.B1_COD
         AND DA1.DA1_CODPRO = A.B1_COD
         AND DA1.DA1_CODTAB = 'IND'
),0) AS IND,
-- Tabela TabLJA
ISNULL(( SELECT TOP 1 DA1.DA1_PRCVEN
       FROM DA1010 AS DA1, SB1010 AS SB1
       WHERE DA1.D_E_L_E_T_ = '' AND SB1.D_E_L_E_T_ = ''
         AND DA1.DA1_CODPRO = SB1.B1_COD
         AND DA1.DA1_CODPRO = A.B1_COD
         AND DA1.DA1_CODTAB = 'LJA'
),0) AS TabLJA,
-- Tabela TabWEB
ISNULL(( SELECT TOP 1 DA1.DA1_PRCVEN
       FROM DA1010 AS DA1, SB1010 AS SB1
       WHERE DA1.D_E_L_E_T_ = '' AND SB1.D_E_L_E_T_ = ''
         AND DA1.DA1_CODPRO = SB1.B1_COD
         AND DA1.DA1_CODPRO = A.B1_COD
         AND DA1.DA1_CODTAB = 'WEB'
),0) AS TabWEB,
-- Saldo Produto  --
ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0101' AND B2_LOCAL IN ('01') AND B2_COD = A.B1_COD ),0) AS SLDFIL01ARZ01,
ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0102' AND B2_LOCAL IN ('01') AND B2_COD = A.B1_COD ),0) AS SLDFIL02ARZ01,
ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0103' AND B2_LOCAL IN ('01') AND B2_COD = A.B1_COD ),0) AS SLDFIL03ARZ01,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0101' AND B2_LOCAL IN ('02') AND B2_COD = A.B1_COD ),0) AS SLDFIL01ARZ02,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0102' AND B2_LOCAL IN ('02') AND B2_COD = A.B1_COD ),0) AS SLDFIL02ARZ02,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0103' AND B2_LOCAL IN ('02') AND B2_COD = A.B1_COD ),0) AS SLDFIL03ARZ02,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0101' AND B2_LOCAL IN ('05') AND B2_COD = A.B1_COD ),0) AS SLDFIL01ARZ05,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0102' AND B2_LOCAL IN ('05') AND B2_COD = A.B1_COD ),0) AS SLDFIL02ARZ05,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0103' AND B2_LOCAL IN ('05') AND B2_COD = A.B1_COD ),0) AS SLDFIL03ARZ05,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0101' AND B2_LOCAL IN ('10') AND B2_COD = A.B1_COD ),0) AS SLDFIL01ARZ10,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0102' AND B2_LOCAL IN ('10') AND B2_COD = A.B1_COD ),0) AS SLDFIL02ARZ10,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0103' AND B2_LOCAL IN ('10') AND B2_COD = A.B1_COD ),0) AS SLDFIL03ARZ10,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0101' AND B2_LOCAL IN ('92') AND B2_COD = A.B1_COD ),0) AS SLDFIL01ARZ92,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0102' AND B2_LOCAL IN ('92') AND B2_COD = A.B1_COD ),0) AS SLDFIL02ARZ92,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0103' AND B2_LOCAL IN ('92') AND B2_COD = A.B1_COD ),0) AS SLDFIL03ARZ92,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0101' AND B2_LOCAL IN ('90') AND B2_COD = A.B1_COD ),0) AS SLDFIL01ARZ90,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0102' AND B2_LOCAL IN ('90') AND B2_COD = A.B1_COD ),0) AS SLDFIL02ARZ90,
--ISNULL((SELECT  SUM(B2_QATU)     FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_FILIAL = '0103' AND B2_LOCAL IN ('90') AND B2_COD = A.B1_COD ),0) AS SLDFIL03ARZ90,

ISNULL((SELECT  SUM(B2_RESERVA)  FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_LOCAL IN ('01') AND B2_COD = A.B1_COD ),0) AS QTDRES,
ISNULL((SELECT (SUM(B2_QATU)-(SUM(B2_RESERVA)+SUM(B2_QEMPPRE)))  FROM SB2010 WHERE D_E_L_E_T_ = '' AND  B2_LOCAL IN ('01') AND B2_COD = A.B1_COD ),0) AS SLDDIS, A.B1_UM,
-- Demanda do Produto
ISNULL((SELECT  SUM(B3_Q01) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS JAN2019,
ISNULL((SELECT  SUM(B3_Q02) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS FEV2019,
ISNULL((SELECT  SUM(B3_Q03) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS MAR2019,
ISNULL((SELECT  SUM(B3_Q04) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS ABR2019,
ISNULL((SELECT  SUM(B3_Q05) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS MAI2019,
ISNULL((SELECT  SUM(B3_Q06) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS JUN2019,
ISNULL((SELECT  SUM(B3_Q07) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS JUL2019,
ISNULL((SELECT  SUM(B3_Q08) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS AGO2019,
ISNULL((SELECT  SUM(B3_Q09) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS SET2019,
ISNULL((SELECT  SUM(B3_Q10) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS OUT2019,
ISNULL((SELECT  SUM(B3_Q11) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS NOV2019,
ISNULL((SELECT  SUM(B3_Q12) FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS DEZ2018,
-- Demanda/Ano
ISNULL((SELECT  SUM(B3_Q01)+SUM(B3_Q02)+SUM(B3_Q03)+SUM(B3_Q04)+SUM(B3_Q05)+SUM(B3_Q06)+
         SUM(B3_Q07)+SUM(B3_Q08)+SUM(B3_Q09)+SUM(B3_Q10)+SUM(B3_Q11)+SUM(B3_Q12) 
         FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS DEMANO,
-- Demanda/Mês
ISNULL((SELECT  (SUM(B3_Q01)+SUM(B3_Q02)+SUM(B3_Q03)+SUM(B3_Q04)+SUM(B3_Q05)+SUM(B3_Q06)+
          SUM(B3_Q07)+SUM(B3_Q08)+SUM(B3_Q09)+SUM(B3_Q10)+SUM(B3_Q11)+SUM(B3_Q12))/12 
         FROM SB3010 WHERE D_E_L_E_T_ = '' AND B3_COD = A.B1_COD ),0) AS DEMMES, SUBSTRING(A.B1_GRUPO,1,2) AS GrpPrd,
         MSBLQL =  CASE WHEN A.B1_MSBLQL = '1' THEN 'BLQ' ELSE 'LIB' END
FROM SB1010 AS A
	FULL JOIN SB3010 AS B ON B.D_E_L_E_T_ = '' AND  A.B1_COD = B.B3_COD
	LEFT JOIN SB2010 AS C ON C.D_E_L_E_T_ = '' AND  A.B1_COD = C.B2_COD
	LEFT JOIN ZB2010 AS D ON D.D_E_L_E_T_ = '' AND	A.B1_ZCODFAM = D.ZB2_CODFAM
	LEFT JOIN SA2010 AS E ON E.D_E_L_E_T_ = '' AND  A.B1_PROC    = E.A2_COD AND A.B1_LOJPROC = E.A2_LOJA 
	LEFT JOIN SB5010 AS F ON F.D_E_L_E_T_ = '' AND A.B1_COD = F.B5_COD
WHERE A.D_E_L_E_T_ = '' 
--	AND A.B1_MSBLQL  = '2'
--	AND A.B1_ZPROMOC = 'S'
	AND SUBSTRING(A.B1_GRUPO,1,2) = 'MR'
--	AND A.B1_COD = 'LB016F'
--	AND A.B1_GRUPO = 'MRUT' 
--	AND A.B1_COD = 'LB012F'   
--AND A.B1_COD = 'IC150F'   
GROUP BY  A.B1_COD,A.B1_ZIDWEB, A.B1_GRUPO,  A.B1_DESC, A.B1_ZDESRDZ,A.B1_PESBRU, B5_ALTURA, B5_COMPR, B5_LARG, CONVERT(VARBINARY(8000),A.B1_ZTITWEB),A.B1_ZAPRES1,A.B1_UM,D.ZB2_DESFAM,A.B1_UCOM,A.B1_GRTRIB,A.B1_ZPROMOC,A.B1_ZMKTPLC, A.B1_SITPROD,A.B1_ZPERDES,A.B1_ZPROWEB,A.B1_ZPDEWEB,A.B1_ZUPSITE,A.B1_PROC,A.B1_LOJPROC,E.A2_NOME,A.B1_CUSTD,A.B1_ZPERCAT,A.B1_ZCODFAM,SUBSTRING(A.B1_GRUPO,1,2),A.B1_MSBLQL,A.B1_ZMIXFL1
ORDER BY 1

