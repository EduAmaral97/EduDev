DEFINE @DT_D1_INI VARCHAR(9)
DEFINE @DT_D1_FIM VARCHAR(9)
DEFINE @DT_D2_INI VARCHAR(9)
DEFINE @DT_D2_FIM VARCHAR(9)
DEFINE @DT_D3_INI VARCHAR(9)
DEFINE @DT_D3_FIM VARCHAR(9)
DECLARE @DT_D1_INI VARCHAR(9)
DECLARE @DT_D1_FIM VARCHAR(9)
DECLARE @DT_D2_INI VARCHAR(9)
DECLARE @DT_D2_FIM VARCHAR(9)
DECLARE @DT_D3_INI VARCHAR(9)
DECLARE @DT_D3_FIM VARCHAR(9)
SET @DT_D1_INI = '20180101'
SET @DT_D1_FIM = '20180131'
SET @DT_D2_INI = '20180101'
SET @DT_D2_FIM = '20180131'
SET @DT_D3_INI = '20180101'
SET @DT_D3_FIM = '20180131'
SELECT 
SALDO.COD_PROD,
SALDO.PRODUTO,
SALDO.QTD_INI_B9,
SALDO.QTD_D1,
SALDO.QTD_D2,
SALDO.QTD_D3,
SALDO.QTD_ENTRADA_D3,
SALDO.QTD_SAIDA_D3,
SALDO.QTD_ENTRADA_D3 - SALDO.QTD_SAIDA_D3 AS SALDO_D3,
SALDO.QTD_INI_B9 + ( SALDO.QTD_D1 + SALDO.QTD_ENTRADA_D3 ) - ( SALDO.QTD_D2 + SALDO.QTD_SAIDA_D3 ) AS SALDO_FINAL
FROM (
SELECT 	A.B1_COD AS COD_PROD,
		A.B1_DESC AS PRODUTO,
		ISNULL(( SELECT SUM(B9_QINI)  FROM SB9010 WHERE D_E_L_E_T_ = '' AND B9_COD = A.B1_COD AND YEAR(B9_DATA) = 2017),0) AS QTD_INI_B9,
		ISNULL(( SELECT SUM(D1_QUANT) FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_COD = A.B1_COD AND D1_DTDIGIT BETWEEN @DT_D1_INI AND @DT_D1_FIM),0) AS QTD_D1,
		ISNULL(( SELECT SUM(D2_QUANT) FROM SD2010 WHERE D_E_L_E_T_ = '' AND D2_COD = A.B1_COD AND D2_EMISSAO BETWEEN @DT_D2_INI AND @DT_D2_FIM),0) AS QTD_D2,
		ISNULL(( SELECT SUM(D3_QUANT) FROM SD3010 WHERE D_E_L_E_T_ = '' AND D3_COD = A.B1_COD AND D3_EMISSAO BETWEEN @DT_D3_INI AND @DT_D3_FIM),0) AS QTD_D3,
		ISNULL(( SELECT SUM(D3_QUANT) FROM SD3010 WHERE 1=1 AND D_E_L_E_T_ = '' AND D3_COD = A.B1_COD AND D3_TM <= '499' AND D3_EMISSAO BETWEEN @DT_D3_INI AND @DT_D3_FIM),0) AS QTD_ENTRADA_D3,
		ISNULL(( SELECT SUM(D3_QUANT) FROM SD3010 WHERE 1=1 AND D_E_L_E_T_ = '' AND D3_COD = A.B1_COD AND D3_TM >= '500' AND D3_EMISSAO BETWEEN @DT_D3_INI AND @DT_D3_FIM),0) AS QTD_SAIDA_D3	
FROM SB1010 A
LEFT JOIN SD1010 B ON A.B1_COD = B.D1_COD AND B.D_E_L_E_T_ = ''
LEFT JOIN SD2010 C ON A.B1_COD = C.D2_COD AND C.D_E_L_E_T_ = ''
LEFT JOIN SD3010 D ON A.B1_COD = D.D3_COD AND D.D_E_L_E_T_ = ''
LEFT JOIN SB9010 E ON A.B1_COD = E.B9_COD AND E.D_E_L_E_T_ = ''
WHERE 1=1
AND A.D_E_L_E_T_ = ''
AND A.B1_COD = 'LB192F'
GROUP BY A.B1_COD, A.B1_DESC
) AS SALDO

