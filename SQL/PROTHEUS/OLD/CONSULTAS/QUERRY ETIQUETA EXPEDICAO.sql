

SELECT 
    SF2.F2_SERIE AS SERIE, 
    SF2.F2_DOC AS DOC, 
    SB1.B1_COD AS CODPROD, 
    SB1.B1_MSBLQL AS PROD_BLQ, 
    CONCAT(SUBSTRING(SF2.F2_EMISSAO,7,2), '/', SUBSTRING(SF2.F2_EMISSAO,5,2), '/', SUBSTRING(SF2.F2_EMISSAO,1,4)) AS EMISSAO,
    SA1.A1_COD AS COD_CLI, 
    SA1.A1_NOME	AS CLIENTE, 
    CONCAT(TRIM(SA1.A1_MUN),' / ',SA1.A1_EST) AS CIDADE,
    CASE 
        WHEN SA4501.A4_COD <> '' THEN SA4501.A4_NOME 
        WHEN SA4.A4_COD <> '' THEN SA4.A4_NOME 
        ELSE '' 
    END AS EXPEDICAO,
    SD2.D2_ITEM,
    SD2.D2_QUANT
FROM SF2010 SF2
    LEFT JOIN SA1010 SA1    ON SA1.D_E_L_E_T_ = ''    AND SA1.A1_COD = SF2.F2_CLIENTE AND SA1.A1_LOJA = SF2.F2_LOJA
    LEFT JOIN SD2010 SD2    ON SD2.D_E_L_E_T_ = ''    AND SD2.D2_FILIAL = SF2.F2_FILIAL AND SD2.D2_SERIE = SF2.F2_SERIE AND SD2.D2_DOC = SF2.F2_DOC
    LEFT JOIN SC9010 SC9    ON SC9.D_E_L_E_T_ = ''    AND SC9.C9_FILIAL = SF2.F2_FILIAL AND SC9.C9_SERIENF = SF2.F2_SERIE AND SC9.C9_NFISCAL = SF2.F2_DOC
    LEFT JOIN SL1010 SL1    ON SL1.D_E_L_E_T_ = ''    AND SL1.L1_FILIAL = SC9.C9_FILIAL AND SL1.L1_PEDRES = SC9.C9_PEDIDO
    LEFT JOIN SUA010 SUA    ON SUA.D_E_L_E_T_ = ''    AND SUA.UA_FILIAL = SL1.L1_FILIAL AND SUA.UA_NUM = SL1.L1_NUMATEN
    LEFT JOIN SL1010 SL1501 ON SL1501.D_E_L_E_T_ = '' AND SL1501.L1_FILIAL = SF2.F2_FILIAL AND SL1501.L1_SERIE = SF2.F2_SERIE AND SL1501.L1_DOC = SF2.F2_DOC
    LEFT JOIN SUA010 SUA501 ON SUA501.D_E_L_E_T_ = '' AND SUA501.UA_FILIAL = SL1501.L1_FILIAL AND SUA501.UA_NUM = SL1501.L1_NUMATEN
    LEFT JOIN SA4010 SA4501 ON SA4501.D_E_L_E_T_ = '' AND SA4501.A4_COD = SUA501.UA_ZCODFRT
    LEFT JOIN SA4010 SA4    ON SA4.D_E_L_E_T_ = ''    AND SA4.A4_COD = SUA.UA_ZCODFRT
    LEFT JOIN SB1010 SB1    ON SB1.D_E_L_E_T_ = ''    AND SB1.B1_COD = SD2.D2_COD
WHERE 1=1
AND SF2.D_E_L_E_T_ = ''
--AND SF2.F2_DOC = '000025958'
GROUP BY 
    SF2.F2_SERIE, 
    SF2.F2_DOC, 
    SF2.F2_EMISSAO, 
    SA1.A1_COD, 
    SA1.A1_NOME,
    SA1.A1_MUN, 
    SA1.A1_EST, 
    SA4.A4_COD, 
    SA4.A4_NOME, 
    SA4501.A4_COD, 
    SA4501.A4_NOME, 
    SB1.B1_MSBLQL, 
    SB1.B1_COD,
    SD2.D2_ITEM,
    SD2.D2_QUANT

